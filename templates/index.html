<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>備品予約システム</title>
  <style>
    section {
      margin-bottom: 2em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      text-align: left;
    }
  </style>
  <!-- FullCalendar CSS & JS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
</head>
<body>
  <h1>備品予約システム</h1>
    <!-- 予約フォーム -->
  <section id="form-section">
    <h2>予約フォーム</h2>
    <form id="reserve-form">
      名前: <input type="text" name="name" required><br>
      <label for="equipmentSelect">備品:</label>
      <select name="equipment_id" id="equipmentSelect" required></select><br>
      開始日: <input type="date" name="start_date" required><br>
      終了日: <input type="date" name="end_date" required><br>
      <button type="submit">予約</button>
    </form>
  </section>
    <!-- 予約一覧 -->
  <section id="list-section">
    <h2>予約一覧</h2>
    <table>
      <thead>
        <tr>
          <th>名前</th>
          <th>備品</th>
          <th>開始日</th>
          <th>終了日</th>
        </tr>
      </thead>
      <tbody id="reservations-table-body">
      </tbody>
    </table>
  </section>
    <!-- カレンダー -->
  <section id="calendar-section">
    <h2>カレンダー</h2>
    <div id="calendar" style="max-width: 900px; margin: 0 auto;"></div>
    </div>
  </section>

<!-- カテゴリ登録フォーム -->
<h2>カテゴリ登録</h2>
<form id="categoryForm">
  <label for="categoryName">カテゴリ名:</label>
  <input type="text" id="categoryName" name="name" required>
  <button type="submit">登録</button>
</form>
<div id="categoryResult"></div>

<h3>カテゴリ一覧</h3>
<ul id="categoryList"></ul>

<!-- 備品登録フォーム -->
<section id="equipment-section">
  <h2>備品登録</h2>
  <form id="equipmentForm">
    <label for="equipmentName">備品名:</label>
    <input type="text" id="equipmentName" name="name" required>
    <label for="equipmentCategory">カテゴリID:</label>
    <input type="number" id="equipmentCategory" name="category_id" required>
    <button type="submit">登録</button>
  </form>
  <div id="equipmentResult"></div>
</section>

<!-- 備品一覧表示 -->
<section id="equipment-list-section">
  <h2>備品一覧</h2>
  <ul id="equipmentList"></ul>
</section>

<script>
  document.getElementById("categoryForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = document.getElementById("categoryName").value;
    const res = await fetch("/api/categories", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name }),
    });
    const result = await res.json();
    document.getElementById("categoryResult").innerText = result.message || result.detail;
    document.getElementById("categoryName").value = "";
    loadCategories(); // 登録後にカテゴリ一覧を更新
  });

  async function loadCategories() {
  const res = await fetch("/api/categories");
  const data = await res.json();
  const list = document.getElementById("categoryList");
  list.innerHTML = "";
  data.forEach(cat => {
    const li = document.createElement("li");
    li.textContent = cat.name;
    list.appendChild(li);
  });
}

async function loadEquipments() {
  const res = await fetch("/api/equipments");
  const data = await res.json();
  const list = document.getElementById("equipmentList");
  list.innerHTML = "";
  data.forEach(e => {
    const li = document.createElement("li");
    li.textContent = `${e.name}（カテゴリ: ${e.category_name || '未分類'}）`;
    list.appendChild(li);
  });
}

// 備品登録後に再読み込みするよう修正
document.getElementById("equipmentForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const name = document.getElementById("equipmentName").value;
  const category_id = document.getElementById("equipmentCategory").value;

  const res = await fetch("/api/equipments", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, category_id }),
  });

  const result = await res.json();
  document.getElementById("equipmentResult").innerText = result.message || result.detail;
  document.getElementById("equipmentForm").reset();
  loadEquipments(); // ⭐ 備品一覧の更新を追加
});
</script>

<script>
  const form = document.getElementById('reserve-form');
  const tableBody = document.getElementById('reservations-table-body');
  function loadReservations() {
    fetch('/api/reservations')
      .then(res => res.json())
      .then(data => {
        tableBody.innerHTML = '';
        data.forEach(r => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${r.name}</td>
            <td>${r.equipment}</td>
            <td>${r.start_date}</td>
            <td>${r.end_date}</td>
            <td>
              <button onclick="editReservation(${r.id})">編集</button>
              <button onclick="deleteReservation(${r.id})">削除</button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      });
  }
  form.addEventListener('submit', (e) => {
    e.preventDefault();
    console.log("submit1: submitting form");
    const formData = new FormData(form);
    fetch('/api/reservations', {
      method: 'POST',
      body: formData
    })
      .then(response => {
      if (!response.ok) {
        throw new Error("登録失敗");
      }
      console.log("登録成功");
      form.reset();
      loadReservations();
      renderCalendar(); // カレンダー再読み込み
    })
  .catch(err => {
    console.error("エラー", err);
  });
  
  });

function editReservation(id) {
  const record = prompt("新しい内容をカンマ区切りで入力（名前,備品,開始日,終了日）:");
  if (!record) return;
  const [name, equipment, start_date, end_date] = record.split(",");
  fetch(`/api/reservations/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, equipment, start_date, end_date })
  })
    .then(res => {
      if (!res.ok) throw new Error("更新失敗");
      return res.json();
    })
    .then(() => {
      loadReservations();
      renderCalendar();
    })
    .catch(err => alert("更新エラー: " + err));
}

function deleteReservation(id) {
  if (!confirm("本当に削除しますか？")) return;
  fetch(`/api/reservations/${id}`, {
    method: 'DELETE'
  })
    .then(res => {
      if (!res.ok) throw new Error("削除失敗");
      return res.json();
    })
    .then(() => {
      loadReservations();
      renderCalendar();
    })
    .catch(err => alert("削除エラー: " + err));
}


  function renderCalendar() {
    const calendarEl = document.getElementById('calendar');
    calendarEl.innerHTML = ''; // 再描画のため初期化

    fetch('/api/reservations')
      .then(res => res.json())
      .then(data => {
        try{

          console.log("取得イベント");
          const events = data.map(r => {
            const endDate = new Date(r.end_date);
            endDate.setDate(endDate.getDate() + 1); // FullCalendarはend日を含まない
            return {
              title: `${r.name} (${r.equipment})`,
              start: r.start_date,
              end: endDate.toISOString().split('T')[0],
            };
          });
          
          const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ja',
            events: events,
          });
          
          calendar.render();
        } catch (error) {
          console.error("カレンダー描画エラー:", error);
 calendarEl.innerHTML = `<p style="color:red;">カレンダー描画中にエラーが発生しました</p>`;
      }
      });
  }

  // 備品セレクトボックスへ備品一覧を読み込む
  function populateEquipmentSelect() {
    fetch("/api/equipments")
      .then(res => res.json())
      .then(data => {
        const select = document.getElementById("equipmentSelect");
        select.innerHTML = "<option value=''>--選択--</option>";
        data.forEach(item => {
          const option = document.createElement("option");
          option.value = item.id;
          option.textContent = `${item.name}（カテゴリ: ${item.category_name || '未分類'}）`;
          select.appendChild(option);
        });
      });
  }

  document.addEventListener('DOMContentLoaded', function () {
    loadReservations();
    renderCalendar();
    loadCategories();
    loadEquipments(); // ⭐ 追加
    populateEquipmentSelect(); // ⭐ 追加
  });
</script>
</body>
</html>